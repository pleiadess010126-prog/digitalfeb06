generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Organization - The root tenant entity for multi-tenancy
model Organization {
  id                   String               @id @default(cuid())
  name                 String
  slug                 String               @unique
  ownerId              String
  plan                 Plan                 @default(free)
  stripeCustomerId     String?              @unique
  stripeSubscriptionId String?              @unique
  brandName            String?
  websiteUrl           String?
  logoUrl              String?
  primaryColor         String?              @default("#8B5CF6")
  timezone             String               @default("UTC")
  defaultLanguage      String               @default("en")
  emailNotifications   Boolean              @default(true)
  weeklyReports        Boolean              @default(true)
  trialStartDate       DateTime?
  trialEndDate         DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  activityLogs         ActivityLog[]
  affiliates           Affiliate[]
  aiAgents             AIAgent[]
  apiKeys              APIKey[]
  campaigns            Campaign[]
  contentItems         ContentItem[]
  invoices             Invoice[]
  members              OrganizationMember[]
  owner                User                 @relation("OrganizationOwner", fields: [ownerId], references: [id])
  platformConnections  PlatformConnection[]
  riskAlerts           RiskAlert[]
  subscriptions        Subscription[]
  topicPillars         TopicPillar[]
  usageRecords         UsageRecord[]
  users                User[]               @relation("OrganizationUsers")

  @@index([slug])
  @@index([ownerId])
  @@index([stripeCustomerId])
  @@map("organizations")
}

/// User - Application users with authentication support
model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String
  passwordHash        String?
  authProvider        AuthProvider         @default(email)
  authProviderId      String?
  avatar              String?
  role                UserRole             @default(viewer)
  organizationId      String?
  lastLoginAt         DateTime?
  emailVerified       Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  activityLogs        ActivityLog[]
  createdApiKeys      APIKey[]
  createdCampaigns    Campaign[]           @relation("CampaignCreator")
  approvedContent     ContentItem[]        @relation("ContentApprover")
  createdContent      ContentItem[]        @relation("ContentCreator")
  organizationMembers OrganizationMember[]
  ownedOrganizations  Organization[]       @relation("OrganizationOwner")
  resolvedAlerts      RiskAlert[]
  assignedTickets     SupportTicket[]      @relation("TicketAssignee")
  tickets             SupportTicket[]
  supportMessages     SupportMessage[]
  organization        Organization?        @relation("OrganizationUsers", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
  @@index([authProvider, authProviderId])
  @@map("users")
}

/// OrganizationMember - Junction table for organization membership
model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           UserRole     @default(viewer)
  invitedBy      String
  invitedAt      DateTime     @default(now())
  acceptedAt     DateTime?
  status         MemberStatus @default(pending)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

/// Campaign - Marketing campaigns with settings and metrics
model Campaign {
  id               String         @id @default(cuid())
  organizationId   String
  name             String
  description      String?
  status           CampaignStatus @default(draft)
  createdBy        String
  websiteUrl       String?
  targetAudience   String?
  industry         String?
  keywords         String[]
  velocityMonth1   Int            @default(10)
  velocityMonth2   Int            @default(20)
  velocityMonth3   Int            @default(30)
  blogEnabled      Boolean        @default(true)
  youtubeEnabled   Boolean        @default(false)
  instagramEnabled Boolean        @default(false)
  facebookEnabled  Boolean        @default(false)
  autoPublish      Boolean        @default(false)
  requireApproval  Boolean        @default(true)
  preferredDays    String[]
  preferredTimes   String[]
  scheduleTimezone String         @default("UTC")
  totalContent     Int            @default(0)
  publishedContent Int            @default(0)
  pendingContent   Int            @default(0)
  totalViews       Int            @default(0)
  totalEngagement  Int            @default(0)
  riskScore        Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  creator          User           @relation("CampaignCreator", fields: [createdBy], references: [id])
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contentItems     ContentItem[]
  riskAlerts       RiskAlert[]
  topicPillars     TopicPillar[]

  @@index([organizationId])
  @@index([status])
  @@index([createdBy])
  @@map("campaigns")
}

/// ContentItem - Generated content pieces
model ContentItem {
  id                  String              @id @default(cuid())
  organizationId      String
  campaignId          String
  title               String
  content             String
  type                ContentType
  status              ContentStatus       @default(draft)
  topicPillarId       String?
  seoScore            Int                 @default(0)
  wordCount           Int                 @default(0)
  readingTime         Int                 @default(0)
  keywords            String[]
  targetKeyword       String?
  hashtags            String[]
  geoScore            Int?
  geoGrade            String?
  geoDirectness       Int?
  geoAuthority        Int?
  geoStructure        Int?
  geoConversational   Int?
  geoFreshness        Int?
  geoSnippetOpt       Int?
  geoSemanticRichness Int?
  geoReadability      Int?
  geoRecommendations  String[]
  geoStrengths        String[]
  aiModel             String?
  generationPrompt    String?
  views               Int                 @default(0)
  engagement          Int                 @default(0)
  shares              Int                 @default(0)
  comments            Int                 @default(0)
  dwellTime           Int                 @default(0)
  bounceRate          Int                 @default(0)
  conversions         Int                 @default(0)
  scheduledFor        DateTime?
  publishedAt         DateTime?
  publishedUrl        String?
  createdBy           String
  approvedBy          String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  approver            User?               @relation("ContentApprover", fields: [approvedBy], references: [id])
  campaign            Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator             User                @relation("ContentCreator", fields: [createdBy], references: [id])
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  topicPillar         TopicPillar?        @relation(fields: [topicPillarId], references: [id])
  publishedPlatforms  PublishedPlatform[]

  @@index([organizationId])
  @@index([campaignId])
  @@index([status])
  @@index([type])
  @@index([scheduledFor])
  @@index([createdBy])
  @@map("content_items")
}

/// PublishedPlatform - Track content published to each platform
model PublishedPlatform {
  id            String        @id @default(cuid())
  contentItemId String
  platform      PlatformType
  postId        String?
  postUrl       String?
  publishedAt   DateTime?
  status        PublishStatus @default(pending)
  error         String?
  contentItem   ContentItem   @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([contentItemId, platform])
  @@index([contentItemId])
  @@index([platform])
  @@map("published_platforms")
}

/// TopicPillar - Content topic clusters
model TopicPillar {
  id             String        @id @default(cuid())
  organizationId String
  campaignId     String
  name           String
  description    String?
  keywords       String[]
  contentCount   Int           @default(0)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  contentItems   ContentItem[]
  campaign       Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([campaignId])
  @@map("topic_pillars")
}

/// PlatformConnection - Social media and CMS platform integrations
model PlatformConnection {
  id             String                   @id @default(cuid())
  organizationId String
  platform       PlatformType
  name           String
  status         PlatformConnectionStatus @default(disconnected)
  accessToken    String?
  refreshToken   String?
  apiKey         String?
  apiSecret      String?
  tokenExpiry    DateTime?
  accountId      String?
  accountName    String?
  accountUrl     String?
  followersCount Int?
  postsCount     Int?
  lastSyncAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, platform])
  @@index([organizationId])
  @@index([platform])
  @@map("platform_connections")
}

/// Subscription - Stripe subscription management
model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String
  stripeSubscriptionId String             @unique
  stripeCustomerId     String
  plan                 Plan
  status               SubscriptionStatus @default(trialing)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  organization         Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

/// UsageRecord - Monthly usage tracking
model UsageRecord {
  id                      String       @id @default(cuid())
  organizationId          String
  month                   String
  contentGenerated        Int          @default(0)
  wordpressPosts          Int          @default(0)
  youtubePosts            Int          @default(0)
  instagramPosts          Int          @default(0)
  facebookPosts           Int          @default(0)
  tiktokPosts             Int          @default(0)
  linkedinPosts           Int          @default(0)
  twitterPosts            Int          @default(0)
  apiCalls                Int          @default(0)
  storageUsedMB           Int          @default(0)
  videoMinutesUsed        Int          @default(0)
  voiceOverCharactersUsed Int          @default(0)
  musicTracksUsed         Int          @default(0)
  aiImagesGenerated       Int          @default(0)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@index([organizationId])
  @@index([month])
  @@map("usage_records")
}

/// Invoice - Billing history
model Invoice {
  id              String        @id @default(cuid())
  organizationId  String
  stripeInvoiceId String        @unique
  amount          Int
  currency        String        @default("usd")
  status          InvoiceStatus @default(draft)
  pdfUrl          String?
  periodStart     DateTime
  periodEnd       DateTime
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@map("invoices")
}

/// AIAgent - Autonomous AI workers
model AIAgent {
  id                 String        @id @default(cuid())
  organizationId     String
  type               AIAgentType
  name               String
  status             AIAgentStatus @default(idle)
  lastActiveAt       DateTime?
  tasksCompleted     Int           @default(0)
  currentTask        String?
  enabled            Boolean       @default(true)
  schedule           String?
  maxConcurrentTasks Int           @default(1)
  priority           String        @default("medium")
  modelPreference    String?
  customInstructions String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  organization       Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type])
  @@index([organizationId])
  @@index([status])
  @@map("ai_agents")
}

/// RiskAlert - SEO and content risk monitoring
model RiskAlert {
  id             String          @id @default(cuid())
  organizationId String
  campaignId     String
  type           RiskAlertType
  severity       RiskSeverity
  title          String
  description    String
  recommendation String
  status         RiskAlertStatus @default(active)
  resolvedAt     DateTime?
  resolvedBy     String?
  createdAt      DateTime        @default(now())
  campaign       Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  resolver       User?           @relation(fields: [resolvedBy], references: [id])

  @@index([organizationId])
  @@index([campaignId])
  @@index([severity])
  @@index([status])
  @@map("risk_alerts")
}

/// ActivityLog - Audit trail for all actions
model ActivityLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  action         String
  entityType     String
  entityId       String
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

/// APIKey - External API access management
model APIKey {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  keyHash        String       @unique
  keyPrefix      String
  permissions    String[]
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  createdBy      String
  createdAt      DateTime     @default(now())
  creator        User         @relation(fields: [createdBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyPrefix])
  @@map("api_keys")
}

/// Affiliate - Affiliate partner management
model Affiliate {
  id              String                 @id @default(cuid())
  organizationId  String
  userId          String?
  email           String
  name            String
  referralCode    String                 @unique
  status          AffiliateStatus        @default(pending)
  tier            String                 @default("bronze")
  commissionRate  Float                  @default(0.20)
  totalReferrals  Int                    @default(0)
  activeReferrals Int                    @default(0)
  totalEarnings   Float                  @default(0)
  pendingEarnings Float                  @default(0)
  paidEarnings    Float                  @default(0)
  paypalEmail     String?
  bankDetails     Json?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  payouts         AffiliatePayout[]
  transactions    AffiliateTransaction[]
  organization    Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([referralCode])
  @@index([status])
  @@map("affiliates")
}

/// AffiliateTransaction - Commission tracking
model AffiliateTransaction {
  id          String    @id @default(cuid())
  affiliateId String
  referralId  String
  amount      Float
  plan        Plan
  description String?
  createdAt   DateTime  @default(now())
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([createdAt])
  @@map("affiliate_transactions")
}

/// AffiliatePayout - Payout tracking
model AffiliatePayout {
  id            String       @id @default(cuid())
  affiliateId   String
  amount        Float
  status        PayoutStatus @default(pending)
  method        String
  transactionId String?
  processedAt   DateTime?
  createdAt     DateTime     @default(now())
  affiliate     Affiliate    @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])

  @@map("affiliate_payouts")
}

/// Session - User session tracking (for token invalidation)
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  isValid   Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

enum Plan {
  free
  lite
  starter
  pro
  enterprise
}

enum UserRole {
  owner
  admin
  editor
  viewer
  superadmin
}

enum AuthProvider {
  email
  google
  github
  cognito
}

enum MemberStatus {
  pending
  active
  suspended
}

enum CampaignStatus {
  draft
  active
  paused
  completed
}

enum ContentType {
  blog
  youtube_short
  instagram_reel
  facebook_story
  tiktok
  linkedin_post
  twitter_post
}

enum ContentStatus {
  draft
  pending
  approved
  scheduled
  published
  rejected
}

enum PlatformType {
  wordpress
  youtube
  instagram
  facebook
  twitter
  linkedin
  tiktok
}

enum PlatformConnectionStatus {
  connected
  disconnected
  error
  expired
}

enum PublishStatus {
  pending
  success
  failed
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  trialing
  incomplete
  paused
}

enum InvoiceStatus {
  draft
  open
  paid
  void
  uncollectible
}

enum AIAgentType {
  supervisor
  seo_worker
  social_worker
  risk_worker
  video_worker
  analytics_worker
  geo_worker
}

enum AIAgentStatus {
  idle
  working
  error
  disabled
}

enum RiskAlertType {
  indexation
  velocity
  quality
  spam
  duplicate
  bounce_rate
  traffic_cliff
}

enum RiskSeverity {
  low
  medium
  high
  critical
}

enum RiskAlertStatus {
  active
  acknowledged
  resolved
  dismissed
}

enum AffiliateStatus {
  pending
  active
  suspended
  rejected
}



enum PayoutStatus {
  pending
  processing
  completed
  failed
}

/// SupportTicket - Helpdesk tickets
model SupportTicket {
  id             String          @id @default(cuid())
  ticketNumber   String          @unique // TKT-202X-XXXX
  userId         String
  userEmail      String
  userName       String?
  subject        String
  description    String
  category       TicketCategory  @default(general)
  priority       TicketPriority  @default(medium)
  status         TicketStatus    @default(open)
  source         String          @default("user") // user, nandu, email
  assignedToId   String?
  assignedToName String?
  resolution     String?
  feedback       String?
  rating         Int?
  nanduContext   Json?           // AI Context
  slaBreached    Boolean         @default(false)
  
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  assignedTo     User?           @relation("TicketAssignee", fields: [assignedToId], references: [id])
  messages       SupportMessage[]

  @@index([userId])
  @@index([status])
  @@index([assignedToId])
  @@map("support_tickets")
}

/// SupportMessage - Messages within a ticket
model SupportMessage {
  id        String   @id @default(cuid())
  ticketId  String
  senderId  String
  senderType String  // user, support, system, nandu
  senderName String
  message   String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender    User          @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("support_messages")
}

enum TicketStatus {
  open
  in_progress
  waiting_on_customer
  waiting_on_support
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
  critical
}

enum TicketCategory {
  general
  technical
  billing
  feature_request
  bug_report
  account
  content
  integration
}
